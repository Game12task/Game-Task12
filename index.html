<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ù‡Ø§Ù… Ù„ÙƒØ³Ø¨ Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±Ø§Øª - GameTask</title>
    <style>
        /* CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø«Ø¨Ø§Øª */
        body { font-family: Arial, sans-serif; background-color: #121212; color: #E0E0E0; margin:0; padding:0; text-align:center;}
        .container { max-width:600px; margin:50px auto; padding:20px; background-color:#1E1E1E; border-radius:15px; box-shadow:0 4px 25px rgba(0,0,0,0.7);}
        h1 { color:#64ffda; font-size:26px; margin-bottom:20px; border-bottom:2px solid rgba(100,255,218,0.2); padding-bottom:10px;}
        .user-info { background-color:#2C2C2C; padding:20px; border-radius:10px; margin-bottom:25px; text-align:right; border:1px solid #64ffda;}
        .balance-section { background-color:#333333; padding:15px; border-radius:10px; margin-bottom:25px; text-align:center; border:2px solid #FFD700;}
        .balance-section p { margin:0; font-size:18px; color:#FFD700;}
        #balance-display { font-size:32px; font-weight:bold; color:#00FF7F; margin-top:5px;}
        .offer-section { background-color:#2C2C2C; padding:15px 0; border-radius:10px; margin-bottom:25px; border:1px solid #3A3A3A; overflow:hidden;}
        .offer-header { color:#FFD700; font-size:20px; margin-bottom:15px; text-align:center; padding-bottom:10px; border-bottom:1px solid rgba(255,215,0,0.2);}
        #cpa-offer-wall-container { min-height:500px;}
        .logout-btn { background-color: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 15px; transition: background-color 0.3s; }
        .logout-btn:hover { background-color: #c82333; }
    </style>
    <script src="auth_handler.js"></script>
</head>
<body>

<div class="container">
    <h1>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ù‡Ø§Ù… Ù„ÙƒØ³Ø¨ Ø§Ù„Ù…Ø§Ù„ (Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±)</h1>
    
    <div class="user-info">
        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§: <span id="username-display" style="color:#64ffda; font-weight:bold;">...</span></p>
        <p>Ù…ÙØ¹Ø±Ù‘ÙÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ID): <span id="user-id-display">...</span></p>
        <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="balance-section">
        <p>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±Ø§Øª (Ù†Ù‚Ø§Ø·):</p>
        <div id="balance-display">--.--</div>
    </div>
    
    <div class="offer-section">
        <div class="offer-header">ğŸ‘‘ GAME TASK ğŸ‘‘ | Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±</div> 
        <div id="cpa-offer-wall-container">
            <p style="text-align:center; color:#ffeb3b; padding:20px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶...</p>
        </div>
    </div>
</div>

<script>
    // ** 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ ÙˆØ§Ù„Ù€ API URL **
    checkAuthAndRedirect();

    // Ø±Ø§Ø¨Ø· API Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ù…Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    const API_URL = 'https://script.google.com/macros/s/AKfycbyI2G_WGjWfwrVG2NcEk1M7WOHer1lXdXsqpQA3XaHepDGwKjNwilyFgXwgTnErgvOoCQ/exec';
    
    // ID Ø¬Ø¯Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶ CPX Research (Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± ÙÙŠ ØµÙˆØ±ØªÙƒ)
    const APP_ID = '30033'; 

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø®Ø²Ù†Ø©
    const userID = localStorage.getItem('game_user_id');
    const username = localStorage.getItem('game_username');
    
    const balanceDisplay = document.getElementById('balance-display');
    const cpaContainer = document.getElementById('cpa-offer-wall-container'); 

    // ** 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ¹Ø±Ø¶ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø¹Ø±ÙˆØ¶ **
    if (userID && username) {
        document.getElementById('username-display').textContent = username;
        document.getElementById('user-id-display').textContent = userID;

        // Ø±Ø§Ø¨Ø· Ø¬Ø¯Ø§Ø± CPX Research Ø§Ù„Ù…ØµØ­Ø­ (ÙŠØ±Ø³Ù„ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø§Ø³Ù…)
        const offerwallSrc = `https://offers.cpx-research.com/index.php?app_id=${APP_ID}&ext_user_id=${userID}&username=${encodeURIComponent(username)}`;

        const iframeCode = `
            <iframe 
                sandbox='allow-popups allow-same-origin allow-scripts allow-top-navigation-by-user-activation allow-popups-to-escape-sandbox' 
                src='${offerwallSrc}' 
                style='width:100%; height:2000px; border:none; display:block;' 
                frameborder='0'>
            </iframe>
        `;
        cpaContainer.innerHTML = iframeCode;
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        fetchBalance(userID);
    }

    // ** 3. ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Apps Script **
    async function fetchBalance(id) {
        try {
            const url = `${API_URL}?action=getBalance&id=${id}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.status === 'success') {
                // Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
                balanceDisplay.textContent = parseFloat(data.Balance).toFixed(2) + ' $';
            } else {
                balanceDisplay.textContent = 'Ø®Ø·Ø£';
                console.error('Error fetching balance:', data.message);
            }
        } catch (error) {
            balanceDisplay.textContent = 'Ø®Ø·Ø£ Ø§ØªØµØ§Ù„';
            console.error('Network Error:', error);
        }
    }

    // ** 4. ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ **
    function logout() {
        localStorage.removeItem('game_user_id');
        localStorage.removeItem('game_username');
        window.location.href = 'login.html';
    }
</script>

</body>
</html>
