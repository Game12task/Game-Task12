// =======================================================
// tasks_handler.js - ملف التحكم الديناميكي بمهام الموقع (30 سؤال) - (مُعَدَّل)
// =======================================================

// -------------------------------------------------------
// 1. بيانات المهام (الـ 30 سؤال كاملة)
// -------------------------------------------------------
const ALL_TASKS_POOL = [
    // القيمة: [ID, الفئة, السؤال, الخيار1, الخيار2, الخيار3, الإجابة الصحيحة]
    ["Q001", "ديني", "ما هي السورة التي سميت باسم إحدى الكائنات الحية وتعتبر من قصار السور؟", "سورة النحل", "سورة العنكبوت", "سورة الفيل", "سورة الفيل"],
    ["Q002", "ديني", "كم مرة ذكر اسم 'محمد' صلى الله عليه وسلم صريحاً في القرآن الكريم؟", "ثلاث مرات", "أربع مرات", "خمس مرات", "أربع مرات"],
    ["Q003", "ديني", "ما هو الركن الثالث من أركان الإسلام؟", "الزكاة", "الصوم", "الحج", "الزكاة"],
    ["Q004", "ديني", "من هو النبي الذي ابتلعه الحوت؟", "إبراهيم", "يوسف", "يونس", "يونس"],
    ["Q005", "ديني", "ما اسم أول غزوة للمسلمين؟", "أحد", "بدر", "الخندق", "بدر"],
    ["Q006", "ديني", "ما هو الشيء الذي خلقه الله واستعظمه؟", "الجنة", "النار", "العرش", "العرش"],
    ["Q007", "ديني", "ما هي الصلاة التي ليس لها أذان ولا إقامة؟", "صلاة الكسوف", "صلاة الجنازة", "صلاة الاستسقاء", "صلاة الجنازة"],
    ["Q008", "ديني", "ما هو أول شهر في التقويم الهجري؟", "صفر", "محرم", "ربيع الأول", "محرم"],
    ["Q009", "ديني", "ما هي كنية النبي صلى الله عليه وسلم؟", "أبو القاسم", "أبو إبراهيم", "أبو عبد الله", "أبو القاسم"],
    ["Q010", "ديني", "من هم 'أهل الكهف'؟", "سبعة وثامنهم كلبهم", "ثمانية وتاسعهم كلبهم", "تسعة وعاشرهم كلبهم", "سبعة وثامنهم كلبهم"],
    ["Q011", "ثقافي", "ما هي عاصمة كندا؟", "فانكوفر", "أوتاوا", "تورنتو", "أوتاوا"],
    ["Q012", "ثقافي", "ما هو اسم الوحدة المستخدمة لقياس شدة التيار الكهربائي؟", "الواط (Watt)", "الأمبير (Ampere)", "الفولت (Volt)", "الأمبير (Ampere)"],
    ["Q013", "ثقافي", "ما هو أطول نهر في العالم؟", "نهر النيل", "نهر الأمازون", "نهر المسيسيبي", "نهر النيل"],
    ["Q014", "ثقافي", "من هو مؤلف رواية 'الحرب والسلام'؟", "دوستويفسكي", "تولستوي", "تشيخوف", "تولستوي"],
    ["Q015", "ثقافي", "ما هي أكبر دولة في العالم من حيث المساحة؟", "الصين", "كندا", "روسيا", "روسيا"],
    ["Q016", "ثقافي", "ما هو العنصر الكيميائي الذي رمزه (Au)؟", "الفضة", "الذهب", "النحاس", "الذهب"],
    ["Q017", "ثقافي", "كم عدد قارات العالم؟", "خمس", "ست", "سبع", "سبع"],
    ["Q018", "ثقافي", "ما هي العملة الرسمية لليابان؟", "الوون", "الين", "اليوان", "الين"],
    ["Q019", "ثقافي", "كم عدد الأضلاع في جسم الإنسان؟", "22", "24", "26", "24"],
    ["Q020", "ثقافي", "ما هو أسرع حيوان بري على وجه الأرض؟", "الأسد", "الفهد الصياد (الشيتا)", "النمر", "الفهد الصياد (الشيتا)"],
    ["Q021", "رياضي", "كم عدد اللاعبين الأساسيين في فريق كرة السلة الذي يلعب داخل الملعب؟", "خمسة", "ستة", "سبعة", "خمسة"],
    ["Q022", "رياضي", "ما هي الدولة التي فازت بأكبر عدد من كؤوس العالم لكرة القدم؟", "ألمانيا", "البرازيل", "إيطاليا", "البرازيل"],
    ["Q023", "رياضي", "ما هو اسم المضمار الذي تُقام عليه سباقات الفورمولا 1 في مدينة موناكو؟", "سيلفرستون", "مونتي كارلو", "سبا-فرانكورشان", "مونتي كارلو"],
    ["Q024", "رياضي", "من هو اللاعب الملقب بـ 'الجوهرة السوداء'؟", "بيليه", "مارادونا", "يوهان كرويف", "بيليه"],
    ["Q025", "رياضي", "ما هي الرياضة التي تستخدم فيها الكرات المصنوعة من الريش (الريشة الطائرة)؟", "التنس", "البادمنتون", "السكواش", "البادمنتون"],
    ["Q026", "رياضي", "كم عدد الأشواط في مباراة كرة اليد؟", "شوطان", "ثلاثة أشواط", "أربعة أشواط", "شوطان"],
    ["Q027", "رياضي", "ما هي مدينة اليونان التي استضافت أول ألعاب أولمبية حديثة؟", "أثينا", "روما", "باريس", "أثينا"],
    ["Q028", "رياضي", "ما هو الوزن التقريبي لكرة القدم الرسمية؟", "350-400 جرام", "400-450 جرام", "450-500 جرام", "400-450 جرام"],
    ["Q029", "رياضي", "ما اسم المضرب المستخدم في لعبة الهوكي على الجليد؟", "Stick", "Racket", "Bat", "Stick"],
    ["Q030", "رياضي", "كم دقيقة هي مدة الاستراحة بين شوطي مباراة كرة القدم؟", "10 دقائق", "15 دقيقة", "20 دقيقة", "15 دقيقة"],
];

// -------------------------------------------------------
// 2. خرائط التدوير اليومي (4 أيام - لكننا نستخدم دورتين Day1 و Day2 حالياً)
// -------------------------------------------------------
const ROTATION_MAPS = {
    // الأحد، الثلاثاء، الخميس (اليوم 1) - أسئلة فردية
    Day1: {
        ديني: ["Q001", "Q003", "Q005", "Q007", "Q009"], 
        ثقافي: ["Q011", "Q013", "Q015", "Q017", "Q019"], 
        رياضي: ["Q021", "Q023", "Q025", "Q027", "Q029"], 
    },
    // الإثنين، الأربعاء، الجمعة (اليوم 2) - أسئلة زوجية
    Day2: {
        ديني: ["Q002", "Q004", "Q006", "Q008", "Q010"], 
        ثقافي: ["Q012", "Q014", "Q016", "Q018", "Q020"], 
        رياضي: ["Q022", "Q024", "Q026", "Q028", "Q030"], 
    },
};

// -------------------------------------------------------
// 3. دالة تحديد قائمة اليوم
// -------------------------------------------------------
function getTodayRotationKey() {
    const today = new Date();
    const rotationCycleLength = 2; // تدوير بين Day1 و Day2 فقط
    const startDate = new Date('2025-01-01'); // تاريخ ثابت لبدء العد
    const diffTime = Math.abs(today - startDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    const rotationIndex = (diffDays % rotationCycleLength) + 1; 
    
    return `Day${rotationIndex}`;
}

// -------------------------------------------------------
// 4. دالة جلب قائمة المهام اليومية لفئة معينة
// -------------------------------------------------------
function getDailyTasksForCategory(category) {
    const rotationKey = getTodayRotationKey();
    const todayTaskIDs = ROTATION_MAPS[rotationKey] ? ROTATION_MAPS[rotationKey][category] || [] : [];
    
    // جلب النصوص الكاملة للأسئلة
    const dailyTasks = todayTaskIDs.map(id => {
        const taskData = ALL_TASKS_POOL.find(task => task[0] === id);
        return taskData ? {
            id: taskData[0],
            category: taskData[1],
            question: taskData[2],
            options: [taskData[3], taskData[4], taskData[5]],
            answer: taskData[6]
        } : null;
    }).filter(task => task !== null); 
    
    return dailyTasks;
}

// -------------------------------------------------------
// 5. دالة التحقق من الإنجاز السابق (منع إعادة الدخول)
// -------------------------------------------------------
function isTaskCompleted(taskId) {
    // نفترض أن كل مستخدم لديه مُعرف فريد
    let userId = localStorage.getItem('user_id');
    if (!userId) {
        // إنشاء مُعرف عشوائي إذا لم يكن موجوداً
        userId = 'user_' + Math.random().toString(36).substring(2, 9);
        localStorage.setItem('user_id', userId);
    }

    const completedTasks = JSON.parse(localStorage.getItem(`completed_tasks_${userId}`) || '{}');

    return completedTasks[taskId] === true;
}

// -------------------------------------------------------
// 6. دالة تسجيل الإنجاز (بعد الإجابة الصحيحة)
// -------------------------------------------------------
function recordTaskCompletion(taskId) {
    const userId = localStorage.getItem('user_id');
    if (!userId) return;

    const completedTasks = JSON.parse(localStorage.getItem(`completed_tasks_${userId}`) || '{}');
    completedTasks[taskId] = true;
    localStorage.setItem(`completed_tasks_${userId}`, JSON.stringify(completedTasks));

    // لاحقاً: هنا يتم إضافة كود النقاط إلى Firebase
}

// -------------------------------------------------------
// 7. دالة عرض قائمة المهام (تستخدم في الصفحة HTML القادمة) - الكود المُعَدَّل
// -------------------------------------------------------
function renderTaskList(category) {
    const tasksListContainer = document.getElementById('tasks-list-container');
    
    // **ترجمة الفئة من الإنجليزي إلى العربي لتطابق البيانات**
    let targetCategory = '';
    const categoryMap = {
        'religious': 'ديني',
        'sports': 'رياضي',
        'culture': 'ثقافي'
    };
    targetCategory = categoryMap[category] || ''; 

    const dailyTasks = getDailyTasksForCategory(targetCategory);
    
    if (!tasksListContainer) return;
    
    // تصحيح عنوان الصفحة ليتناسب مع الترجمة
    const categoryNames = {
        'religious': 'الدينية',
        'sports': 'الرياضية',
        'culture': 'الثقافية'
    };
    const categoryTitle = categoryNames[category] || 'المهام';
    document.getElementById('page-title').textContent = `مهام اليوم ${categoryTitle} (5 أسئلة)`;


    tasksListContainer.innerHTML = ''; 

    if (dailyTasks.length === 0) {
        tasksListContainer.innerHTML = `<p style="text-align: center; color: #f44336;">عذراً، لا توجد مهام ${targetCategory} جديدة متاحة اليوم.</p>`;
        return;
    }

    dailyTasks.forEach((task, index) => {
        const isCompleted = isTaskCompleted(task.id);
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item-card';
        
        let statusText = isCompleted ? '✅ مكتمل' : '🟢 ابدأ الآن';
        let statusClass = isCompleted ? 'completed' : 'available';
        
        taskItem.innerHTML = `
            <h3>التحدي رقم ${index + 1}: ${task.category}</h3>
            <p>${task.question.substring(0, 50)}...</p>
            <span class="status ${statusClass}">${statusText}</span>
        `;
        
        if (!isCompleted) {
            // هذا هو الرابط الذي سيأخذ المستخدم إلى صفحة حل السؤال (الخطوة القادمة)
            taskItem.onclick = () => { 
                window.location.href = `dynamic_task_question.html?task_id=${task.id}`; 
            };
            taskItem.style.cursor = 'pointer';
        } else {
             taskItem.style.opacity = '0.5'; 
        }

        tasksListContainer.appendChild(taskItem);
    });
    }
