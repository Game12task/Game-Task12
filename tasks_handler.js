// =======================================================
// tasks_handler.js - ملف التحكم الديناميكي بمهام الموقع (30 سؤال)
// =======================================================

// -------------------------------------------------------
// 1. بيانات المهام (الـ 30 سؤال كاملة)
// ملاحظة: تم تعديل القائمة لتكون على شكل كائنات (Objects) لتسهيل القراءة واستخدام المفتاح (Key) بدلاً من الفهرس (Index)
// -------------------------------------------------------
const ALL_TASKS_POOL = [
    // القيمة: [ID, الفئة, السؤال, الخيار1, الخيار2, الخيار3, الإجابة الصحيحة, نقاط المكافأة] 
    // ملاحظة: سنضيف النقاط هنا لنتذكر مكافأة كل مهمة (افتراضياً 1 نقطة لكل مهمة)
    ["Q001", "ديني", "ما هي السورة التي سميت باسم إحدى الكائنات الحية وتعتبر من قصار السور؟", "سورة النحل", "سورة العنكبوت", "سورة الفيل", "سورة الفيل", 1],
    ["Q002", "ديني", "كم مرة ذكر اسم 'محمد' صلى الله عليه وسلم صريحاً في القرآن الكريم؟", "ثلاث مرات", "أربع مرات", "خمس مرات", "أربع مرات", 1],
    ["Q003", "ديني", "ما هو الركن الثالث من أركان الإسلام؟", "الزكاة", "الصوم", "الحج", "الزكاة", 1],
    ["Q004", "ديني", "من هو النبي الذي ابتلعه الحوت؟", "إبراهيم", "يوسف", "يونس", "يونس", 1],
    ["Q005", "ديني", "ما اسم أول غزوة للمسلمين؟", "أحد", "بدر", "الخندق", "بدر", 1],
    ["Q006", "ديني", "ما هو الشيء الذي خلقه الله واستعظمه؟", "الجنة", "النار", "العرش", "العرش", 1],
    ["Q007", "ديني", "ما هي الصلاة التي ليس لها أذان ولا إقامة؟", "صلاة الكسوف", "صلاة الجنازة", "صلاة الاستسقاء", "صلاة الجنازة", 1],
    ["Q008", "ديني", "ما هو أول شهر في التقويم الهجري؟", "صفر", "محرم", "ربيع الأول", "محرم", 1],
    ["Q009", "ديني", "ما هي كنية النبي صلى الله عليه وسلم؟", "أبو القاسم", "أبو إبراهيم", "أبو عبد الله", "أبو القاسم", 1],
    ["Q010", "ديني", "من هم 'أهل الكهف'؟", "سبعة وثامنهم كلبهم", "ثمانية وتاسعهم كلبهم", "تسعة وعاشرهم كلبهم", "سبعة وثامنهم كلبهم", 1],
    
    ["Q011", "ثقافي", "ما هي عاصمة كندا؟", "فانكوفر", "أوتاوا", "تورنتو", "أوتاوا", 1],
    ["Q012", "ثقافي", "ما هو اسم الوحدة المستخدمة لقياس شدة التيار الكهربائي؟", "الواط (Watt)", "الأمبير (Ampere)", "الفولت (Volt)", "الأمبير (Ampere)", 1],
    ["Q013", "ثقافي", "ما هو أطول نهر في العالم؟", "نهر النيل", "نهر الأمازون", "نهر المسيسيبي", "نهر النيل", 1],
    ["Q014", "ثقافي", "من هو مؤلف رواية 'الحرب والسلام'؟", "دوستويفسكي", "تولستوي", "تشيخوف", "تولستوي", 1],
    ["Q015", "ثقافي", "ما هي أكبر دولة في العالم من حيث المساحة؟", "الصين", "كندا", "روسيا", "روسيا", 1],
    ["Q016", "ثقافي", "ما هو العنصر الكيميائي الذي رمزه (Au)؟", "الفضة", "الذهب", "النحاس", "الذهب", 1],
    ["Q017", "ثقافي", "كم عدد قارات العالم؟", "خمس", "ست", "سبع", "سبع", 1],
    ["Q018", "ثقافي", "ما هي العملة الرسمية لليابان؟", "الوون", "الين", "اليوان", "الين", 1],
    ["Q019", "ثقافي", "كم عدد الأضلاع في جسم الإنسان؟", "22", "24", "26", "24", 1],
    ["Q020", "ثقافي", "ما هو أسرع حيوان بري على وجه الأرض؟", "الأسد", "الفهد الصياد (الشيتا)", "النمر", "الفهد الصياد (الشيتا)", 1],
    
    ["Q021", "رياضي", "كم عدد اللاعبين الأساسيين في فريق كرة السلة الذي يلعب داخل الملعب؟", "خمسة", "ستة", "سبعة", "خمسة", 1],
    ["Q022", "رياضي", "ما هي الدولة التي فازت بأكبر عدد من كؤوس العالم لكرة القدم؟", "ألمانيا", "البرازيل", "إيطاليا", "البرازيل", 1],
    ["Q023", "رياضي", "ما هو اسم المضمار الذي تُقام عليه سباقات الفورمولا 1 في مدينة موناكو؟", "سيلفرستون", "مونتي كارلو", "سبا-فرانكورشان", "مونتي كارلو", 1],
    ["Q024", "رياضي", "من هو اللاعب الملقب بـ 'الجوهرة السوداء'؟", "بيليه", "مارادونا", "يوهان كرويف", "بيليه", 1],
    ["Q025", "رياضي", "ما هي الرياضة التي تستخدم فيها الكرات المصنوعة من الريش (الريشة الطائرة)؟", "التنس", "البادمنتون", "السكواش", "البادمنتون", 1],
    ["Q026", "رياضي", "كم عدد الأشواط في مباراة كرة اليد؟", "شوطان", "ثلاثة أشواط", "أربعة أشواط", "شوطان", 1],
    ["Q027", "رياضي", "ما هي مدينة اليونان التي استضافت أول ألعاب أولمبية حديثة؟", "أثينا", "روما", "باريس", "أثينا", 1],
    ["Q028", "رياضي", "ما هو الوزن التقريبي لكرة القدم الرسمية؟", "350-400 جرام", "400-450 جرام", "450-500 جرام", "400-450 جرام", 1],
    ["Q029", "رياضي", "ما اسم المضرب المستخدم في لعبة الهوكي على الجليد؟", "Stick", "Racket", "Bat", "Stick", 1],
    ["Q030", "رياضي", "كم دقيقة هي مدة الاستراحة بين شوطي مباراة كرة القدم؟", "10 دقائق", "15 دقيقة", "20 دقيقة", "15 دقيقة", 1],
];

// -------------------------------------------------------
// 2. خرائط التدوير اليومي (5 أسئلة لكل فئة/يوم)
// -------------------------------------------------------
const ROTATION_MAPS = {
    // الأحد، الثلاثاء، الخميس (اليوم 1) - أسئلة فردية
    Day1: {
        ديني: ["Q001", "Q003", "Q005", "Q007", "Q009"], 
        ثقافي: ["Q011", "Q013", "Q015", "Q017", "Q019"], 
        رياضي: ["Q021", "Q023", "Q025", "Q027", "Q029"], 
    },
    // الإثنين، الأربعاء، الجمعة (اليوم 2) - أسئلة زوجية
    Day2: {
        ديني: ["Q002", "Q004", "Q006", "Q008", "Q010"], 
        ثقافي: ["Q012", "Q014", "Q016", "Q018", "Q020"], 
        رياضي: ["Q022", "Q024", "Q026", "Q028", "Q030"], 
    },
    // السبت - يمكن أن نخصص له يوماً ثالثاً أو نجعله يوماً حراً (حالياً يتبع Day2)
};

// -------------------------------------------------------
// 3. دالة تحديد قائمة اليوم (للتدوير بين Day1 و Day2)
// -------------------------------------------------------
function getTodayRotationKey() {
    const today = new Date();
    // نستخدم دورة الأيام لتحديد مفتاح التدوير (Day1 أو Day2)
    const dayOfWeek = today.getDay(); // الأحد 0، الإثنين 1، ...، السبت 6

    if (dayOfWeek === 0 || dayOfWeek === 2 || dayOfWeek === 4) { // الأحد، الثلاثاء، الخميس
        return "Day1";
    } else if (dayOfWeek === 1 || dayOfWeek === 3 || dayOfWeek === 5) { // الإثنين، الأربعاء، الجمعة
        return "Day2";
    } else { // السبت (يمكنك تعديل هذا لربطه بـ Day1 أو Day2 حسب رغبتك)
        return "Day2"; 
    }
}

// -------------------------------------------------------
// 4. دالة جلب قائمة المهام اليومية لفئة معينة
// **هذه هي الدالة التي سيتم استدعاؤها في dynamic_task_list.html**
// -------------------------------------------------------
function getCurrentDailyTasks(category) {
    const rotationKey = getTodayRotationKey();
    const todayTaskIDs = ROTATION_MAPS[rotationKey] ? ROTATION_MAPS[rotationKey][category] || [] : [];
    
    // جلب النصوص الكاملة للأسئلة
    const dailyTasks = todayTaskIDs.map(id => {
        const taskData = ALL_TASKS_POOL.find(task => task[0] === id);
        return taskData ? {
            id: taskData[0],
            category: taskData[1],
            question: taskData[2],
            options: [taskData[3], taskData[4], taskData[5]],
            answer: taskData[6],
            reward: taskData[7] // نقاط المكافأة (نقطة واحدة)
        } : null;
    }).filter(task => task !== null); 
    
    return dailyTasks;
}

// -------------------------------------------------------
// 5. دالة جلب بيانات مهمة واحدة بالآيدي
// -------------------------------------------------------
function getTaskById(taskId) {
    const taskData = ALL_TASKS_POOL.find(task => task[0] === taskId);
    return taskData ? {
        id: taskData[0],
        category: taskData[1],
        question: taskData[2],
        options: [taskData[3], taskData[4], taskData[5]],
        answer: taskData[6],
        reward: taskData[7]
    } : null;
}

// -------------------------------------------------------
// 6. دالة التحقق من الإنجاز السابق
// -------------------------------------------------------
function isTaskCompleted(taskId) {
    const userId = localStorage.getItem('user_id');
    if (!userId) return false;

    // المهام يتم تجديدها يومياً، لذا يجب أن يكون الإكمال مرتبطاً باليوم والمهمة
    const rotationKey = getTodayRotationKey();
    const completedTasksKey = `completed_tasks_${userId}_${rotationKey}`;
    
    const completedTasks = JSON.parse(localStorage.getItem(completedTasksKey) || '{}');
    
    return completedTasks[taskId] === true;
}

// -------------------------------------------------------
// 7. دالة تسجيل الإنجاز (تسجيل الإكمال لهذا اليوم)
// **هذه الدالة يتم استدعاؤها في dynamic_task_question_solver.html**
// -------------------------------------------------------
function recordTaskCompletion(taskId) {
    const userId = localStorage.getItem('user_id');
    if (!userId) return;

    const rotationKey = getTodayRotationKey();
    const completedTasksKey = `completed_tasks_${userId}_${rotationKey}`;

    const completedTasks = JSON.parse(localStorage.getItem(completedTasksKey) || '{}');
    completedTasks[taskId] = true;
    localStorage.setItem(completedTasksKey, JSON.stringify(completedTasks));

    // // ملاحظة: منح النقاط (grantPoints) يتم استدعاؤها في صفحة الحل
            }
